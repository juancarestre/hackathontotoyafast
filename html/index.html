<!DOCTYPE html>
<html>

<head>

    <title>tcd</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="index.css">
    <link href="https://fonts.googleapis.com/css2?family=Oswald&display=swap" rel="stylesheet">
    
    
    <script>
        var fileVin;
        var filePlate;
        var apiendpoint = 'https://b6ze4r4q74.execute-api.us-east-1.amazonaws.com/tcd-prototype-get-signed-url'
        function myFunction() {

        }

        function WebSocketTest() {
            var websocketurl = "wss://tol3bxt5gl.execute-api.us-east-1.amazonaws.com/l"
            if ("WebSocket" in window) {
                var ws = new WebSocket(websocketurl);
                ws.onopen = function () {
                    // alert("connected to: " + websocketurl);
                    console.log("connected to: " + websocketurl);

                };

                ws.onmessage = function (evt) {
                    var received_msg = evt.data;
                    document.getElementById("demo").innerHTML = document.getElementById("demo").innerHTML + "<br/>" + new Date().toISOString() + " ~> " + received_msg;
                };

                ws.onclose = function () {
                    alert("Connection is closed...");
                };
            } else {
                alert("WebSocket NOT supported by your Browser!");
            }
        }

        async function getUrlImage(queryParam) {
            const url = `https://b6ze4r4q74.execute-api.us-east-1.amazonaws.com/tcd-prototype-get-signed-url?path=${queryParam}`;
            const response = await fetch(url, {method: 'GET'});

            if (response.ok) {
                return await response.json();
            } else {
                alert("HTTP-Error: " + response.status);
            }
        }

        async function sendImage(urlImgae, isVin) {
            const file = isVin ? fileVin : filePlate;
            const response = await fetch(urlImgae, {
                method: 'PUT',
                headers: {
                    "Content-Type": "image/png"
                },
                body: file
            });

            if (response.ok) {
                return await response;
            } else {
                alert("HTTP-Error: " + response.status);
            }
        }

        async function uploadFile(theForm, isVin) {
            const queryParam = isVin ? 'vin' : 'plate';
            const urlImage = await getUrlImage(queryParam);
            const imageResponse = await sendImage(urlImage.signedUrl, isVin);
        }

        function getImageFile(file, isVin) {
            if (isVin) {
                fileVin = file;
            } else {
                filePlate = file;
            }
            return window.URL.createObjectURL(file);
        }
    </script>
</head>

<body class="main-container">
    <div class="main_title">
        <h2>Image Recognition Vin and License Plates</h2>
    </div>

    <div class="content">
        <div class="form-image">
            <div class="custom-file">
                <input type="file" id="plate" class="custom-file-input" name="filename" onchange="document.getElementById('plateImage').src = getImageFile(this.files[0], false)">
                <label class="custom-file-label" for="validatedCustomFile">Choose Plate...</label>
                <div class="invalid-feedback">Example invalid custom file feedback</div>
            </div>
            <img id="plateImage" src="" class="form-image__image" onerror="this.src='./assets/placeholder_image.svg'">        
            <button onclick="uploadFile(this, false)" class="btn btn-primary form-image__submit" >Save plate</button>
        </div>
    
        <div class="form-image">
            <div class="custom-file">
                <input type="file" id="vin" class="custom-file-input" name="filenamex" onchange="document.getElementById('vinImage').src = getImageFile(this.files[0], true)" required>
                <label class="custom-file-label" for="validatedCustomFile">Choose VIN...</label>
                <div class="invalid-feedback">Example invalid custom file feedback</div>
            </div>
            <img id="vinImage" src="" class="form-image__image" onerror="this.src='./assets/placeholder_image.svg'"> 
            <button  class="btn btn-primary form-image__submit" onclick="uploadFile(this, true)" >Save vin</button>
        </div>
    </div>



    <script>
        WebSocketTest();
    </script>
    <p id="demo"></p>
</body>

</html>